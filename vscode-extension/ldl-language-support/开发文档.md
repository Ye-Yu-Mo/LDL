# LDL Language Support 开发文档

## 📖 项目概述

LDL Language Support 是一个为 Learning Domain Language (LDL) 提供的 VS Code 插件。LDL 是一种专门用于描述学习方法论和知识框架的领域特定语言 (DSL)。

### 🎯 项目目标
- 为 LDL 提供完整的 IDE 支持
- 支持方法论的标签化管理和分类
- 提供智能导航和搜索功能
- 为学习方法论的描述和管理提供工具支持

### 🏗️ 技术架构
- **语言**: TypeScript
- **框架**: VS Code Extension API
- **构建工具**: TypeScript Compiler
- **语法高亮**: TextMate Grammar (JSON)

---

## 📁 项目结构

```
ldl-language-support/
├── src/                          # TypeScript 源码
│   ├── extension.ts             # 插件入口点
│   ├── parser.ts                # LDL 语言解析器
│   ├── definitionProvider.ts   # 定义跳转提供器
│   ├── documentSymbolProvider.ts # 文档符号提供器
│   └── workspaceSymbolProvider.ts # 工作区符号提供器
├── out/                         # 编译输出目录
├── syntaxes/                    # 语法高亮定义
│   └── ldl.tmLanguage.json     # TextMate 语法文件
├── examples/                    # 示例 LDL 文件
│   └── test.ldl                # 测试用例
├── docs/                        # 文档目录
│   ├── 使用文档.md
│   ├── LDL关键字参考.md
│   └── LDL变量类型参考.md
├── package.json                 # 插件配置和依赖
├── tsconfig.json               # TypeScript 配置
├── language-configuration.json  # 语言配置
└── README.md                   # 项目说明
```

---

## 🛠️ 核心组件详解

### 1. **LDL Parser (`src/parser.ts`)**

#### 功能职责
- 解析 LDL 文档并提取符号信息
- 支持函数、pipeline、类、常量、宏等的解析
- 处理 `@label` 装饰器和文档注释
- 维护符号索引和标签索引

#### 核心接口
```typescript
export interface LDLSymbol {
    name: string;
    position: vscode.Position;
    type: 'function' | 'pipeline' | 'type_alias' | 'macro' | 'constant' | 'class' | 'method';
    version?: string;           // 版本化函数支持
    labels?: string[];          // 标签列表
    documentation?: string;     // 文档注释
    className?: string;         // 所属类名
    parentClass?: string;       // 父类名
    isStatic?: boolean;         // 是否静态方法
}
```

#### 关键方法
```typescript
export class LDLParser {
    // 解析整个文档
    parseDocument(document: vscode.TextDocument): void

    // 查找符号（支持版本和类名）
    findSymbol(name: string, version?: string, className?: string): LDLSymbol | undefined
    findAllSymbols(name: string, version?: string, className?: string): LDLSymbol[]

    // 标签相关查询
    findSymbolsByLabel(label: string): LDLSymbol[]
    getAllLabels(): string[]
    getSymbolsByLabels(): Map<string, LDLSymbol[]>
}
```

#### 解析流程
1. **文档解析**: `parseDocument()` → 清理缓存 → 调用各个解析器
2. **符号提取**: 使用正则表达式匹配各种语法结构
3. **标签解析**: `parseLabelsAndDocumentation()` → 向前查找装饰器
4. **索引构建**: 同时维护名称索引和标签索引

---

### 2. **Definition Provider (`src/definitionProvider.ts`)**

#### 功能职责
- 提供 "跳转到定义" 功能 (`Ctrl+Click`, `F12`)
- 支持函数重载的多定义选择
- 版本化函数的智能跳转

#### 实现逻辑
```typescript
export class LDLDefinitionProvider implements vscode.DefinitionProvider {
    provideDefinition(
        document: vscode.TextDocument,
        position: vscode.Position,
        token: vscode.CancellationToken
    ): vscode.ProviderResult<vscode.Definition> {
        // 1. 解析文档
        this.parser.parseDocument(document);

        // 2. 获取光标下的词
        const word = document.getText(wordRange);

        // 3. 检测上下文（函数调用 vs 类型引用）
        if (isFunctionCall) {
            // 4a. 提取版本信息
            const version = extractVersion(lineText);
            // 4b. 查找所有匹配的定义
            const symbols = this.parser.findAllSymbols(word, version);
            // 4c. 返回单个或多个定义
            return createLocationArray(symbols);
        } else {
            // 4d. 处理类型、常量等的跳转
        }
    }
}
```

#### 特殊处理
- **版本检测**: 识别 `fn(version: "name")` 调用模式
- **类方法**: 支持 `Class.method()` 跳转
- **多定义**: 返回 `vscode.Location[]` 让用户选择

---

### 3. **Document Symbol Provider (`src/documentSymbolProvider.ts`)**

#### 功能职责
- 文档大纲显示 (`Ctrl+Shift+O`)
- 按标签分组的符号导航
- 层次化的符号结构展示

#### 核心功能
```typescript
export class LDLDocumentSymbolProvider implements vscode.DocumentSymbolProvider {
    provideDocumentSymbols(document: vscode.TextDocument): vscode.DocumentSymbol[] {
        // 1. 解析文档获取所有符号
        this.parser.parseDocument(document);

        // 2. 按标签分组
        const symbolsByLabels = this.parser.getSymbolsByLabels();

        // 3. 创建标签文件夹节点
        for (const [label, symbols] of symbolsByLabels) {
            const labelNode = new vscode.DocumentSymbol(
                `📁 ${label}`,
                `${symbols.length} items`,
                vscode.SymbolKind.Namespace,
                range, range
            );

            // 4. 添加子符号
            for (const symbol of symbols) {
                labelNode.children.push(createDocumentSymbol(symbol));
            }
        }

        // 5. 处理无标签符号
        const unlabeledSymbols = getUnlabeledSymbols();
        // ...
    }
}
```

#### 显示效果
```
📁 philosophy
  ├── 🔧 dialectical_materialism (function) - 辩证唯物主义分析方法
  └── 🔧 practice_cognition (function) - 实践认识论方法
📁 learning
  ├── 🔧 SQ3R (function) - 系统化阅读方法
  └── ⚡ comprehensive_learning (pipeline) - 完整学习流程
📄 Unlabeled
  └── 🔧 helper_function (function)
```

---

### 4. **Workspace Symbol Provider (`src/workspaceSymbolProvider.ts`)**

#### 功能职责
- 全局符号搜索 (`Ctrl+T`)
- 支持多种搜索模式
- 工作区范围的符号发现

#### 搜索模式
```typescript
class LDLWorkspaceSymbolProvider {
    private filterSymbols(parser: LDLParser, query: string): LDLSymbol[] {
        const queryLower = query.toLowerCase();

        // 1. 标签搜索: @label:name 或 label:name
        const labelMatch = query.match(/^@?label:\s*(.+)$/i);
        if (labelMatch) {
            return parser.findSymbolsByLabel(labelMatch[1]);
        }

        // 2. 类型搜索: type:function 或 t:fn
        const typeMatch = query.match(/^t(?:ype)?:\s*(.+)$/i);
        if (typeMatch) {
            return filterByType(allSymbols, typeMatch[1]);
        }

        // 3. 名称/文档搜索
        return fuzzySearch(allSymbols, queryLower);
    }
}
```

#### 缓存机制
- 文档解析结果缓存
- 基于文件修改时间的智能失效
- 多文件搜索性能优化

---

### 5. **语法高亮 (`syntaxes/ldl.tmLanguage.json`)**

#### TextMate Grammar 结构
```json
{
    "name": "LDL",
    "scopeName": "source.ldl",
    "patterns": [
        { "include": "#comments" },
        { "include": "#keywords" },
        { "include": "#strings" },
        { "include": "#decorators" },
        { "include": "#functions" },
        { "include": "#function_calls" },
        // ...
    ],
    "repository": {
        "keywords": {
            "patterns": [
                {
                    "name": "keyword.control.ldl",
                    "match": "\\b(fn|pipeline|class|using|macro|const)\\b"
                }
            ]
        }
        // ...
    }
}
```

#### 高亮特性
- **关键字**: 语言核心关键字
- **装饰器**: `@label("name")` 特殊高亮
- **函数调用**: 命名参数和版本信息
- **类型标注**: 内置和自定义类型
- **注释**: 支持文档注释 `///`

---

## 🔧 开发环境搭建

### 前置要求
```bash
# Node.js 版本要求
node --version  # >= 16.0.0
npm --version   # >= 8.0.0

# VS Code 版本要求
# VS Code >= 1.60.0
```

### 项目初始化
```bash
# 1. 克隆项目
git clone <repository-url>
cd ldl-language-support

# 2. 安装依赖
npm install

# 3. 编译项目
npm run compile

# 4. 启动开发模式
npm run watch  # 监听文件变化自动编译
```

### 开发调试
```bash
# 方式1: VS Code 调试
# 按 F5 启动调试窗口

# 方式2: 手动启动
code --extensionDevelopmentPath=. --new-window
```

---

## 📝 代码规范

### TypeScript 编码规范

#### 1. 命名约定
```typescript
// ✅ 类名: PascalCase
class LDLDefinitionProvider { }

// ✅ 方法名: camelCase
provideDefinition() { }

// ✅ 变量名: camelCase
const symbolPosition = document.positionAt(index);

// ✅ 常量: UPPER_SNAKE_CASE
const MAX_SEARCH_RESULTS = 100;

// ✅ 接口: PascalCase with I prefix (可选)
interface LDLSymbol { }
```

#### 2. 类型标注
```typescript
// ✅ 显式类型标注
function parseDocument(document: vscode.TextDocument): void {
    const symbols: Map<string, LDLSymbol[]> = new Map();
    const text: string = document.getText();
}

// ✅ 返回类型标注
function findSymbol(name: string): LDLSymbol | undefined {
    return this.symbols.get(name)?.[0];
}
```

#### 3. 错误处理
```typescript
// ✅ 适当的错误处理
try {
    const document = await vscode.workspace.openTextDocument(uri);
    const parser = await this.getParserForDocument(document);
    return parser.getAllSymbols();
} catch (error) {
    console.error(`Error parsing ${uri.toString()}:`, error);
    return [];
}
```

### 代码组织原则

#### 1. 单一职责
```typescript
// ✅ 每个类专注一个功能
class LDLParser {
    // 只负责解析LDL语法
}

class LDLDefinitionProvider {
    // 只负责定义跳转功能
}
```

#### 2. 依赖注入
```typescript
// ✅ 构造函数注入依赖
class LDLDefinitionProvider {
    constructor(private parser: LDLParser) {}
}
```

#### 3. 接口隔离
```typescript
// ✅ 定义清晰的接口
interface SymbolProvider {
    findSymbol(name: string): LDLSymbol | undefined;
    getAllSymbols(): LDLSymbol[];
}
```

---

## 🧪 测试策略

### 单元测试结构
```typescript
// test/parser.test.ts
describe('LDLParser', () => {
    let parser: LDLParser;

    beforeEach(() => {
        parser = new LDLParser();
    });

    describe('parseDocument', () => {
        it('should parse function definitions', () => {
            const document = createMockDocument(`
                fn test_function() -> Steps {
                    return result
                }
            `);

            parser.parseDocument(document);
            const symbols = parser.getAllSymbols();

            expect(symbols).toHaveLength(1);
            expect(symbols[0].name).toBe('test_function');
            expect(symbols[0].type).toBe('function');
        });

        it('should parse labels correctly', () => {
            const document = createMockDocument(`
                @label("test")
                fn labeled_function() -> Steps {
                    return result
                }
            `);

            parser.parseDocument(document);
            const symbols = parser.findSymbolsByLabel('test');

            expect(symbols).toHaveLength(1);
            expect(symbols[0].name).toBe('labeled_function');
        });
    });
});
```

### 集成测试
```typescript
// test/integration.test.ts
describe('Extension Integration', () => {
    it('should provide correct definitions', async () => {
        const document = await vscode.workspace.openTextDocument(testFileUri);
        const position = new vscode.Position(10, 5);

        const definitions = await vscode.commands.executeCommand(
            'vscode.executeDefinitionProvider',
            document.uri,
            position
        );

        expect(definitions).toBeDefined();
        expect(definitions.length).toBeGreaterThan(0);
    });
});
```

### 测试运行
```bash
# 运行所有测试
npm test

# 运行特定测试文件
npm test -- --grep "LDLParser"

# 生成覆盖率报告
npm run test:coverage
```

---

## 📊 性能优化

### 1. 解析器优化

#### 缓存策略
```typescript
class LDLParser {
    private documentCache = new Map<string, {
        version: number;
        symbols: LDLSymbol[];
        lastModified: number;
    }>();

    parseDocument(document: vscode.TextDocument): void {
        const uri = document.uri.toString();
        const version = document.version;

        // 检查缓存
        const cached = this.documentCache.get(uri);
        if (cached && cached.version === version) {
            this.symbols = new Map(cached.symbols);
            return;
        }

        // 重新解析
        this.actualParse(document);

        // 更新缓存
        this.documentCache.set(uri, {
            version,
            symbols: Array.from(this.symbols.entries()),
            lastModified: Date.now()
        });
    }
}
```

#### 惰性加载
```typescript
class LDLWorkspaceSymbolProvider {
    private symbolCache = new Map<string, LDLSymbol[]>();

    async provideWorkspaceSymbols(query: string): Promise<vscode.SymbolInformation[]> {
        // 只解析查询相关的文件
        const relevantFiles = await this.findRelevantFiles(query);

        for (const file of relevantFiles) {
            if (!this.symbolCache.has(file.toString())) {
                await this.parseFile(file);
            }
        }

        return this.filterAndFormat(query);
    }
}
```

### 2. 内存管理

#### 定期清理
```typescript
class ExtensionManager {
    private cleanupTimer?: NodeJS.Timeout;

    activate() {
        // 每30分钟清理一次缓存
        this.cleanupTimer = setInterval(() => {
            this.cleanupOldCaches();
        }, 30 * 60 * 1000);
    }

    private cleanupOldCaches(): void {
        const now = Date.now();
        const maxAge = 60 * 60 * 1000; // 1小时

        for (const [uri, cache] of this.documentCache) {
            if (now - cache.lastModified > maxAge) {
                this.documentCache.delete(uri);
            }
        }
    }
}
```

### 3. 搜索优化

#### 索引构建
```typescript
class SearchIndex {
    private nameIndex = new Map<string, LDLSymbol[]>();
    private labelIndex = new Map<string, LDLSymbol[]>();
    private fuzzyIndex: FuzzySearch<LDLSymbol>;

    buildIndex(symbols: LDLSymbol[]): void {
        // 构建名称索引
        for (const symbol of symbols) {
            this.addToIndex(this.nameIndex, symbol.name, symbol);

            // 构建标签索引
            if (symbol.labels) {
                for (const label of symbol.labels) {
                    this.addToIndex(this.labelIndex, label, symbol);
                }
            }
        }

        // 构建模糊搜索索引
        this.fuzzyIndex = new FuzzySearch(symbols, {
            keys: ['name', 'documentation', 'labels']
        });
    }
}
```

---

## 🚀 部署和发布

### 本地打包
```bash
# 1. 安装 vsce 工具
npm install -g vsce

# 2. 打包插件
vsce package

# 3. 生成 .vsix 文件
# 输出: ldl-language-support-0.1.0.vsix
```

### 本地测试安装
```bash
# 安装本地插件
code --install-extension ldl-language-support-0.1.0.vsix

# 卸载插件
code --uninstall-extension ldl-language-support
```

### 发布到市场
```bash
# 1. 登录发布者账号
vsce login <publisher-name>

# 2. 发布插件
vsce publish

# 3. 发布特定版本
vsce publish 1.0.1
```

### 版本管理
```json
// package.json
{
  "version": "0.1.0",
  "engines": {
    "vscode": "^1.60.0"
  }
}
```

#### 语义化版本
- **0.x.y**: 开发版本
- **1.0.0**: 首个稳定版本
- **1.x.0**: 新功能版本
- **1.0.x**: 问题修复版本

---

## 🔮 未来规划

### Phase 1: 核心功能完善
- [ ] 自动补全功能
- [ ] 悬停信息显示
- [ ] 错误检查和诊断
- [ ] 代码片段支持

### Phase 2: 可视化增强
- [ ] 方法论流程图生成
- [ ] 标签关系网络图
- [ ] 统计分析面板
- [ ] 文档导出功能

### Phase 3: 协作和集成
- [ ] Git 集成优化
- [ ] 团队协作功能
- [ ] 外部工具集成
- [ ] API 接口开放

### Phase 4: AI 增强
- [ ] 智能方法论推荐
- [ ] 自然语言查询
- [ ] 自动文档生成
- [ ] 个性化学习路径

---

## 📞 贡献指南

### 提交规范
```bash
# 提交信息格式
<type>(<scope>): <description>

# 例子
feat(parser): add support for nested function calls
fix(syntax): correct highlighting for version parameters
docs(readme): update installation instructions
```

### 开发工作流
1. **Fork 项目** → 创建个人分支
2. **功能开发** → 在 feature 分支开发
3. **测试验证** → 确保所有测试通过
4. **提交 PR** → 详细描述变更内容
5. **代码审查** → 响应审查意见
6. **合并主分支** → 功能集成

### 问题报告
使用 GitHub Issues 模板：
- **Bug 报告**: 详细重现步骤
- **功能请求**: 使用场景和期望行为
- **文档改进**: 具体的改进建议

---

## 📚 相关资源

### 官方文档
- [VS Code Extension API](https://code.visualstudio.com/api)
- [TextMate Grammar Guide](https://macromates.com/manual/en/language_grammars)
- [Language Server Protocol](https://microsoft.github.io/language-server-protocol/)

### 开发工具
- [VS Code Extension Generator](https://github.com/Microsoft/vscode-generator-code)
- [Extension Test Runner](https://github.com/microsoft/vscode-test)
- [VSCE Publishing Tool](https://github.com/microsoft/vscode-vsce)

### 参考项目
- [TypeScript Extension](https://github.com/microsoft/TypeScript)
- [Python Extension](https://github.com/microsoft/vscode-python)
- [Markdown Extension](https://github.com/microsoft/vscode-markdown-tm-grammar)

---

*最后更新: 2024年9月*
*维护者: LDL 开发团队*